%%% $Id: intex.sty 18 2005-08-02 00:34:50Z mtr $
%%%
%%% Copyright (C) 2005 by Martin Thorsen Ranang
%%%
\def\filename{intex}
\def\fileversion{v0.1}
\def\filedate{2005/08/02}
\def\docdate{2005/08/02}
\NeedsTeXFormat{LaTeX2e}[1994/06/01]
\ProvidesPackage{intex}[\filedate\space\fileversion\space Support for concept, acronym, and proper-name typesetting and indexing]

\newif\if@itx@index%
\@itx@indextrue% The default is to perform indexing.
\DeclareOption{noindex}{\@itx@indexfalse}

% Whether InTeX should include in-document warnings about undefined
% concepts or not.
\newif\if@itx@warn@undef%
\@itx@warn@undeftrue% The default is to warn about undefined concepts.
\DeclareOption{nowarnundef}{\@itx@warn@undeffalse}

% Whether the short version of each first-occurrence of a concept (per
% significant part) should also be typeset as a margin-label.  One
% conditional for each of the concept kinds; PLAIN, ACRONYM, and
% PERSON.
\newif\if@itx@margin@plain%
\newif\if@itx@margin@acronym%
\newif\if@itx@margin@person%
\@itx@margin@plaintrue%
\@itx@margin@acronymtrue%
\@itx@margin@persontrue%
\DeclareOption{nomarginplain}{\@itx@margin@plainfalse}
\DeclareOption{nomarginacronym}{\@itx@margin@acronymfalse}
\DeclareOption{nomarginperson}{\@itx@margin@personfalse}

\ProcessOptions

\if@itx@index%
  \RequirePackage{index}% Do indexing.
\else%
  % A handy macro usually defined in index.sty.
  \def\@nearverbatim{\expandafter\strip@prefix\meaning}%
\fi

\RequirePackage{acronym}

%\newcommand{\InTeX}{I{\raise.5ex\hbox{N}\kern-.2em}\TeX}
%\newcommand{\InTeX}{I{\sc n\kern-.07em}\TeX}

% Font-definitions.
%   For plain concepts:
\newcommand{\itxplaindeffont}[1]{\emph{#1}}
\newcommand{\itxplainfollowfont}[1]{#1}
\newcommand{\itxplainmarginfont}[1]{\raggedright\footnotesize\textsf{#1}}
%   For acronyms:
\newcommand{\itxacronymdeffont}[1]{#1}
\newcommand{\itxacronymdefshortfont}[1]{\emph{#1}}
\newcommand{\itxacronymshortfont}[1]{#1}
\newcommand{\itxacronymmarginfont}[1]{\raggedright\footnotesize\textsf{#1}}
%   For persons:
\newcommand{\itxpersondeffont}[1]{\emph{#1}}
\newcommand{\itxpersonfirstfont}[1]{#1}
\newcommand{\itxpersonlastfont}[1]{#1}
\newcommand{\itxpersonmarginfont}[1]{\raggedright\footnotesize\textsf{#1}}

\if@itx@index%
  \makeindex%
  \newindex{raw}{rix}{rid}{Raw Index}%
\fi%

% The comment to display where undefined concepts are detected.
\newcommand*\itxundefcomment[1]{\emph{(undefined concept #1)}}

% Define a couple of convenience macros.
\long\def\@firstofthree#1#2#3{#1}%
\long\def\@secondofthree#1#2#3{#2}%

% Make it possible to reset the ``defined'' flag for each concept.
% After a reset, the next time that concept occurs, it is typeset as
% if it's the first occurrence of that concept.
\def\ITX@reset#1{%
  \global\expandafter\let\csname itx@#1\endcsname\relax}

% A macro to typeset the concepts at first-occurrence points in the
% margin.
\newcommand*\@itxmarginlabel[2]{%
  \hspace{0pt}%
  \ifcase#1%
    % Plain.
    \if@itx@margin@plain%
      \marginpar{\itxplainmarginfont{\ITX@itxs{#1}{#2}}}%
    \fi%
  \or%
    % Acronym.
    \if@itx@margin@acronym%
      \marginpar{\itxacronymmarginfont{\ITX@itxs{#1}{#2}}}%
    \fi%
  \or%
    % Person.
    \if@itx@margin@person%
      \marginpar{\itxpersonmarginfont{\ITX@itxl{#1}{#2}}}%
    \fi%
  \fi%
}
\newcommand*\ITX@used{@<>@<>@}% Value to flag a concept as used.
\newcommand*\ITX@get[3]{%
  \ifx#1\relax%
  \else%
    \expandafter#2#1%\null%
  \fi%
}

% Significant-area definitions.  When these counters change, the
% concepts concerned will be typeset as first occurrences.
\newcommand*\itxplainarea{\thesubparagraph.\thepage}% Plain.
\newcommand*\itxacronymarea{\thesubparagraph.\thepage}% Acronym.
\newcommand*\itxpersonarea{\thesubsubsection}% Person.
\newcommand*\@itxarea[1]{%
  \ifcase#1%
    \itxplainarea%
  \or%
    \itxacronymarea%
  \or%
    \itxpersonarea%
  \fi%
}
% The default (empty) area definitions.
\def\itx@last@pos0{}%
\def\itx@last@pos1{}%
\def\itx@last@pos2{}%

\newcommand*\ITX@itxs[2]{%
  \expandafter\ITX@get\csname fn\number#1@#2\endcsname\@firstoftwo{#2}}
\newcommand*\ITX@itxl[2]{%
  \expandafter\ITX@get\csname fn\number#1@#2\endcsname\@secondoftwo{#2}}
\newcommand*{\itxs}[2]{%
  \texorpdfstring{\protect\@itxs{#1}{#2}}{#1}}
\newcommand*{\@itxs}[2]{%
  \ifcase#1%
    % Plain.
    \itxplainfollowfont{\ITX@itxs{#1}{#2}}%
  \or%
    % Acronym.
    \itxacronymshortfont{\ITX@itxs{#1}{#2}}%
  \or%
    % Person.
    \itxpersonlastfont{\ITX@itxl{#1}{#2}}%
  \fi%
}
\newcommand*{\itxl}{\protect\@itxl}
\newcommand*{\@itxl}[2]{%
   \ITX@itxl{#1}{#2}%
 }
\newcommand*{\itxf}[2]{%
  \texorpdfstring{\protect\@itxf{#1}{#2}}{\ITX@itxl{#1}{#2} (#1)}%
 }
\newcommand*{\@itxf}[2]{%
  \ifcase#1%
    % Plain.
    % Typeset margin-notes if applicable.
    \@itxmarginlabel{#1}{#2}%
    % Typeset the concept.
    \itxplaindeffont{\ITX@itxs{#1}{#2}}\nolinebreak %
  \or%
    % Acronym.
    % Typeset the concept.  Note in-between margin label.
    \itxacronymdeffont{%
      \ITX@itxl{#1}{#2} %
      %\nolinebreak[3] %
      % Typeset margin-notes if applicable.
      \@itxmarginlabel{#1}{#2}%
      % Continue typesetting the concept.
      \itxacronymdefshortfont{%
        \itxacronymshortfont{(\ITX@itxs{#1}{#2})}}\nolinebreak %
    }%
  \or%
    % Person.
    % Typeset the concept.  Note in-between margin label.
    \itxpersondeffont{%
      \itxpersonfirstfont{%
        \ITX@itxs{#1}{#2}} %
      %\nolinebreak[3] %
      % Typeset margin-notes if applicable.
      \@itxmarginlabel{#1}{#2}%
      % Continue typesetting the concept.
      \itxpersonlastfont{%
        \ITX@itxl{#1}{#2}%
      }%
    }%
  \fi%
  %% Now, do the used/unused accounting.
  \expandafter\ifx\csname itx@#2\endcsname\ITX@used%
    %\relax%
  \else%
    \global\expandafter\let\csname itx@#2\endcsname\ITX@used%
    %\ITX@addtoclearlist{#2}% MTR
  \fi%
  %\ITX@logged{#2} MTR
}

\newcommand*{\@itxplain}[2]{%
  % Record this area:
  \edef\curr@pos{\@itxarea{#1}}%
  % Remember the last area where this concept (#2) was used.
  \edef\last@pos{\csname itx@last@pos\number#1@#2 \endcsname}%
  \ifx\curr@pos\last@pos%
    % We're still in the same area.  Hence, we do nothing.
  \else%
    % The area has changed.
    \ITX@reset{#2}%
  \fi%
  \expandafter\xdef\csname itx@last@pos\number#1@#2 \endcsname{\curr@pos}%
  %% Now, typeset the concept.
  \expandafter\ifx\csname itx@#2\endcsname\ITX@used%
    \itxs{#1}{#2}%
  \else%
    \itxf{#1}{#2}%
  \fi%
}
\newcommand*{\@itxalias}[2]{%
  % Define the id of the equivalent entry.
  \edef\@tempn{#2}%
  \def\@equiv{#1}%
  \edef\@kind{fn\number#2}%
  \def\@ekind{\@kind e}%
  % Get the ID of the main index entry for which this is an alias.
  \def\@orig{\expandafter\ITX@get\csname%
    \@ekind @\@equiv\endcsname\@firstofthree\@equiv}%
  % Keep the original definition as \@ORIGDEF.
  \edef\@origdef{\csname \@kind @\@orig\endcsname}%
  % Redefine the main entry:
  % (As in \expandafter\gdef\csname fn@#1\endcsname{{#2}{#2}}.)
  \expandafter\gdef\csname \@kind @\@orig\endcsname{%
    {\expandafter\ITX@get\csname%
      \@ekind @\@equiv\endcsname\@secondofthree\@equiv}%
    {\expandafter\ITX@get\csname%
      \@ekind @\@equiv\endcsname\@thirdofthree\@equiv}%
  }%
  % Now, typeset the alias by using the main index entry ID.
  \@itxplain{\@tempn}{\@orig}%
  % Finally, reset the definition of the main entry.
  \expandafter\xdef\csname \@kind @\@orig\endcsname{\@origdef}%
}
\newcommand{\@itx@fakeindex}[1]{%
  \begingroup%
    \edef\@tempa{%
      \write\@auxout{%
        \string\@writefile{raw}{%
          \string\indexentry{#1}%
          {0}%
        }%
      }%
    }%
  \expandafter\endgroup\@tempa%
}
\newcommand{\co}{\protect\@itx}
\newcommand*{\@itx}[1]{%
  \def\@tempa{#1}%
  \edef\@tempb{\@nearverbatim\@tempa}% Handles e.g. backslashes.
  \if@itx@index%
    \index[raw]{#1}% The intricacies of indexing is handled by
                   % makeintex.
  \else%
    \@itx@fakeindex{\@tempb}% Fake the index entries (all occurrences
                            % on page 0.
  \fi%
  \newif\iffound%
  \newcount\n% Initial value is 0.
  \loop\ifnum\n<3%
    % Check to see if the argument is an {acronym/person} alias.
    \expandafter\ifx\csname fn\number\n e@\@tempb\endcsname\relax%
      % Check to see if the argument is a MAIN entry.
      \expandafter\ifx\csname fn\number\n @\@tempb\endcsname\relax\else%
        % It is a MAIN entry.
        \@itxplain{\n}{\@tempb}% Typeset it.
        \foundtrue%
      \fi%
    \else%
      % It is an ALIAS entry.
      \@itxalias{\@tempb}{\n}%
      \foundtrue%
    \fi%
    %% Then increase N by 1.
    \advance\n+1%
  \repeat%
  %%
  \iffound%
  \else%
    \PackageWarning{intex}{Concept `#1' is not defined}%
    \if@itx@warn@undef%
      \textbf{\itxundefcomment{#1}}%
    \else%
      #1%
    \fi%
  \fi%
}

\newcommand*{\personused}[1]{%
  \expandafter\ifx\csname pnused@#1\endcsname\PN@used%
    \relax%
  \else%
    \global\expandafter\let\csname pnused@#1\endcsname\PN@used%
    \global\let\PN@populated\PN@used%
  \fi%
}
\newcommand*\newconcept[3]{%
  \def\@tempa{#1}%
  \edef\@tempb{\@nearverbatim\@tempa}%
  \@newentry{0}{\@tempb}{#2}{#3}%
}
\newcommand*\newacronym[3]{%
  \@newentry{1}{#1}{#2}{#3}%
}
\newcommand*\newperson[3]{%
  \@newentry{2}{#1}{#2}{#3}%
}
\newcommand\@newentry[4]{%
  \expandafter\gdef\csname fn#1@#2\endcsname{{#3}{#4}}%
}

% Explanations of the arguments for \new{acro,person}equiv{}:
%   #1 identifies the ``parent'' acronym/person,
%   #2 defines how this equivalent should be typeset in text,
%   #3 identifies the equivalent form (as in \co{#3}), and
%   #4 represents the spelled-out form of the equivalent.
\newcommand\newconceptequiv[4]{%
  \expandafter\gdef\csname fn0e@#3\endcsname{{#1}{#2}{#4}}%
}
\newcommand\newacronymequiv[4]{%
  \expandafter\gdef\csname fn1e@#3\endcsname{{#1}{#2}{#4}}%
}
\newcommand\newpersonequiv[4]{%
  \expandafter\gdef\csname fn2e@#3\endcsname{{#1}{#2}{#4}}%
}

%%% Local Variables: 
%%% mode: latex
%%% buffer-file-coding-system: latin-1-unix
%%% TeX-master: "test"
%%% ispell-local-dictionary: "american"
%%% mode: flyspell
%%% End: 
